{% extends 'base.html' %}


{% block title %}Record Payment - ERP System{% endblock %}
{% block page_title %}Record Payment{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">New Payment Details</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger mb-4">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <!-- Section: Who & What -->
                    <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">Payer Information</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">Customer <span class="text-danger">*</span></label>
                            {{ form.customer }}
                            {% if form.customer.errors %}
                            <div class="text-danger small mt-1">{{ form.customer.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">Selecting a customer will load their unpaid invoices
                                below.</div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Link to Specific Invoice <span
                                    class="text-muted fw-normal">(Optional)</span></label>
                            {{ form.invoice }}
                            {% if form.invoice.errors %}
                            <div class="text-danger small mt-1">{{ form.invoice.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">Leave blank to automatically apply to oldest invoices.
                            </div>
                        </div>
                    </div>

                    <!-- Section: Transaction Details -->
                    <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">Payment Details</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Payment Date <span class="text-danger">*</span></label>
                            {{ form.payment_date }}
                            {% if form.payment_date.errors %}
                            <div class="text-danger small mt-1">{{ form.payment_date.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Amount (Rs) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">Rs</span>
                                {{ form.amount }}
                            </div>
                            {% if form.amount.errors %}
                            <div class="text-danger small mt-1">{{ form.amount.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Payment Method</label>
                            {{ form.payment_method }}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Reference # / Notes</label>
                            {{ form.reference }}
                            {% if form.reference.errors %}
                            <div class="text-danger small mt-1">{{ form.reference.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Section: Notes -->
                    <div class="mb-4">
                        <label class="form-label">Internal Notes</label>
                        {{ form.notes }}
                    </div>

                    <!-- Invoice Allocation Section (Loaded via HTMX) -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <h6 class="mb-3 fw-bold text-primary">Invoice Allocation</h6>
                            <div class="alert alert-warning py-2 small mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>FIFO Mode:</strong> Payments are applied to the oldest unpaid invoices first by
                                default.
                            </div>

                            <div id="unpaid-invoices-list" class="bg-white rounded border p-3">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-arrow-up-circle fs-4 d-block mb-2"></i>
                                    Select a customer above to view unpaid invoices.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 pt-2 border-top">
                        <a href="{% url 'payments:list' %}" class="btn btn-light border px-4">Cancel</a>
                        <button type="submit" class="btn btn-primary px-5 fw-bold">
                            <i class="bi bi-check2-circle me-1"></i> Record Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Help / Context Sidebar -->
        <div class="card shadow-sm border-0 bg-primary text-white mb-3"
            style="background: linear-gradient(45deg, #0d6efd, #0dcaf0);">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-lightbulb"></i> Pro Tip</h5>
                <p class="card-text small">
                    Always verify the "Unallocated Amount" after saving. Any excess payment will be stored as a credit
                    on the customer's account for future invoices.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}